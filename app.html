<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام المراسلة الداخلي | Intranet Messenger</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sidebar-item-active {
            background-color: #e0f2fe;
            color: #0284c7;
            border-right: 4px solid #0284c7;
        }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden text-gray-800">

    <!-- ==================== APP CONTAINER ==================== -->
    <div id="app" class="w-full h-full relative">

        <!-- LOGIN VIEW -->
        <div id="view-login"
            class="w-full h-full flex items-center justify-center bg-gradient-to-br from-brand-900 to-brand-600">
            <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 fade-in">
                <div class="text-center mb-8">
                    <img src="logo.webp" alt="شعار المحافظة" class="w-24 h-24 mx-auto mb-4 object-contain">
                    <h1 class="text-2xl font-bold text-gray-800">نظام المراسلة الداخلي</h1>
                    <p class="text-gray-500 text-sm mt-1">محافظة المثنى الادارة العامة والمحلية</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم</label>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute right-3 top-3 text-gray-400"></i>
                            <input type="text" id="username"
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
                                placeholder="ادخل اسم المستخدم" required value="admin">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                        <div class="relative">
                            <i class="fa-solid fa-lock absolute right-3 top-3 text-gray-400"></i>
                            <input type="password"
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
                                placeholder="••••••••" required value="123456">
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-2.5 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
                        تسجيل الدخول
                    </button>
                    <p class="text-center text-xs text-gray-400 mt-4">محمي بتشفير End-to-End محلي</p>
                    <p class="text-center text-xs text-gray-300 mt-2 font-mono">تصميم وبرمجة قسم تكنلوجيا المعلومات</p>
                </form>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="hidden w-full h-full flex bg-gray-50">

            <!-- Sidebar -->
            <div class="w-64 bg-white border-l border-gray-200 flex flex-col shadow-lg z-10">
                <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                    <img src="logo.webp" alt="Logo" class="w-12 h-12 object-contain">
                    <div>
                        <h2 class="font-bold text-gray-800">نظام المراسلات</h2>
                        <span class="text-xs text-green-500 animate-pulse">● متصل بالشبكة</span>
                    </div>
                </div>

                <nav class="flex-1 p-4 space-y-2">
                    <button onclick="switchTab('inbox')" id="nav-inbox"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition sidebar-item-active">
                        <i class="fa-solid fa-inbox w-5"></i>
                        <span class="flex-1 text-right">البريد الوارد</span>
                        <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">3</span>
                    </button>
                    <button onclick="switchTab('compose')" id="nav-compose"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-pen-to-square w-5"></i>
                        <span>إنشاء كتاب جديد</span>
                    </button>
                    <button onclick="switchTab('sent')" id="nav-sent"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-paper-plane w-5"></i>
                        <span>البريد الصادر</span>
                    </button>
                    <button onclick="switchTab('archive')" id="nav-archive"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-box-archive w-5"></i>
                        <span>الأرشيف</span>
                    </button>
                    <!-- Admin Only Tab -->
                    <button onclick="switchTab('users')" id="nav-users"
                        class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition border-t border-gray-100 mt-2">
                        <i class="fa-solid fa-users-gear w-5"></i>
                        <span>إدارة المستخدمين</span>
                    </button>
                </nav>

                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg mb-3">
                        <img src="https://ui-avatars.com/api/?name=Admin+User&background=0ea5e9&color=fff"
                            class="w-8 h-8 rounded-full">
                        <div class="overflow-hidden">
                            <h4 class="text-sm font-bold truncate">المدير العام</h4>
                            <p class="text-xs text-gray-500 truncate">قسم IT</p>
                        </div>
                    </div>
                    <button onclick="logout()"
                        class="w-full text-red-500 text-sm hover:bg-red-50 py-2 rounded-lg transition">
                        <i class="fa-solid fa-right-from-bracket ml-2"></i> تسجيل الخروج
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden">
                <!-- Header -->
                <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shadow-sm">
                    <h2 id="page-title" class="text-xl font-bold text-gray-800">البريد الوارد</h2>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <input type="text" placeholder="بحث برقم الكتاب..."
                                class="bg-gray-100 px-4 py-2 pr-10 rounded-full text-sm focus:ring-2 focus:ring-brand-500 focus:bg-white transition w-64">
                            <i class="fa-solid fa-magnifying-glass absolute right-3 top-2.5 text-gray-400"></i>
                        </div>
                        <button class="relative p-2 text-gray-500 hover:bg-gray-100 rounded-full transition">
                            <i class="fa-solid fa-bell"></i>
                            <span
                                class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>
                    </div>
                </header>

                <!-- Page Content -->
                <main class="flex-1 overflow-auto p-8 bg-gray-50 relative">

                    <!-- TAB: INBOX -->
                    <div id="tab-inbox" class="fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-50 border-b border-gray-100 text-gray-500">
                                    <tr>
                                        <th class="px-6 py-4 font-medium">الجهة المرسلة</th>
                                        <th class="px-6 py-4 font-medium">الموضوع / عنوان الكتاب</th>
                                        <th class="px-6 py-4 font-medium">رقم الكتاب</th>
                                        <th class="px-6 py-4 font-medium">التاريخ</th>
                                        <th class="px-6 py-4 font-medium">الحالة</th>
                                        <th class="px-6 py-4 font-medium">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 text-gray-700">
                                    <tr class="hover:bg-brand-50 transition cursor-pointer group">
                                        <td class="px-6 py-4 font-bold text-gray-900 flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                                                <i class="fa-solid fa-building"></i>
                                            </div>
                                            قسم الموارد البشرية
                                        </td>
                                        <td class="px-6 py-4">طلب تحديث بيانات الموظفين 2025</td>
                                        <td class="px-6 py-4 font-mono text-xs">HR-2024-892</td>
                                        <td class="px-6 py-4 text-gray-500">2024/12/28</td>
                                        <td class="px-6 py-4"><span
                                                class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">جديد</span>
                                        </td>
                                        <td class="px-6 py-4"><button
                                                class="text-brand-600 hover:bg-brand-50 px-3 py-1 rounded-lg">فتح</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-brand-50 transition cursor-pointer group">
                                        <td class="px-6 py-4 font-bold text-gray-900 flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                                                <i class="fa-solid fa-sack-dollar"></i>
                                            </div>
                                            قسم الحسابات
                                        </td>
                                        <td class="px-6 py-4">مصادقة صرفيات شهر تشرين الثاني</td>
                                        <td class="px-6 py-4 font-mono text-xs">ACC-2024-110</td>
                                        <td class="px-6 py-4 text-gray-500">2024/12/27</td>
                                        <td class="px-6 py-4"><span
                                                class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">مقرؤ</span>
                                        </td>
                                        <td class="px-6 py-4"><button
                                                class="text-brand-600 hover:bg-brand-50 px-3 py-1 rounded-lg">فتح</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-brand-50 transition cursor-pointer group">
                                        <td class="px-6 py-4 font-bold text-gray-900 flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                                <i class="fa-solid fa-gavel"></i>
                                            </div>
                                            القانونية
                                        </td>
                                        <td class="px-6 py-4">التعميم الإداري رقم 5</td>
                                        <td class="px-6 py-4 font-mono text-xs">LAW-2024-005</td>
                                        <td class="px-6 py-4 text-gray-500">2024/12/26</td>
                                        <td class="px-6 py-4"><span
                                                class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">مقرؤ</span>
                                        </td>
                                        <td class="px-6 py-4"><button
                                                class="text-brand-600 hover:bg-brand-50 px-3 py-1 rounded-lg">فتح</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB: COMPOSE -->
                    <div id="tab-compose" class="hidden fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 max-w-4xl mx-auto">
                            <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b border-gray-100 pb-4">
                                <i class="fa-solid fa-pen-nib text-brand-600"></i>
                                تفاصيل الكتاب الرسمي
                            </h3>

                            <form onsubmit="handleSend(event)" class="grid grid-cols-12 gap-6">
                                <!-- Row 0: From & To -->
                                <div class="col-span-12 md:col-span-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">من الجهة
                                        (المرسلة)</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-building absolute right-3 top-3 text-gray-400"></i>
                                        <input type="text" id="sender-entity"
                                            class="w-full pr-10 pl-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition bg-gray-50 focus:bg-white"
                                            placeholder="أدخل الجهة المرسلة..." value="مديرية الإدارة المحلية">
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">يمكنك تعديل الجهة المرسلة في حال أرشفة بريد
                                        ورقي</p>
                                </div>

                                <div class="col-span-12 md:col-span-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">إلى الجهة
                                        (المستلمة)</label>
                                    <div class="flex gap-2">
                                        <input list="departments-list" id="recipient-select"
                                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none"
                                            placeholder="اختر أو اكتب جهة...">
                                        <datalist id="departments-list">
                                            <option value="قسم الموارد البشرية">
                                            <option value="قسم الحسابات">
                                            <option value="قسم القانونية">
                                            <option value="مكتب المدير العام">
                                        </datalist>
                                        <button type="button" onclick="addRecipient()"
                                            class="bg-brand-100 text-brand-600 hover:bg-brand-200 px-4 rounded-lg transition">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="recipients-list" class="flex flex-wrap gap-2 mt-3 empty:hidden"></div>
                                </div>

                                <div class="col-span-12 md:col-span-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع الأولوية</label>
                                    <select
                                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                        <option>عادي</option>
                                        <option class="text-red-500 font-bold">عاجل جداً</option>
                                        <option class="text-orange-500">سري وشخصي</option>
                                    </select>
                                </div>

                                <!-- Row 2: Title -->
                                <div class="col-span-12">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">عنوان الكتاب
                                        (الموضوع)</label>
                                    <input type="text"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none"
                                        placeholder="مثال: طلب شراء أجهزة حاسوب">
                                </div>

                                <!-- Row 3: Numbers & Dates -->
                                <div class="col-span-6 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم الصادر</label>
                                    <input type="text"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none"
                                        placeholder="">
                                </div>
                                <div class="col-span-6 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الصادر</label>
                                    <input type="date"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                                <div class="col-span-6 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم الوارد</label>
                                    <input type="text"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none"
                                        placeholder="">
                                </div>
                                <div class="col-span-6 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الوارد</label>
                                    <input type="date"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>

                                <!-- Text Body -->
                                <div class="col-span-12">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نص الرسالة</label>
                                    <textarea rows="8"
                                        class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-brand-500 outline-none"
                                        placeholder="يرجى كتابة تفاصيل الكتاب الرسمي هنا..."></textarea>
                                </div>

                                <!-- Attachments -->
                                <div class="col-span-12">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المرفقات (رفع ملف أو مسح
                                        ضوئي)</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div
                                            class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition cursor-pointer">
                                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2"></i>
                                            <span class="text-sm text-gray-500">رفع ملف (PDF/IMG)</span>
                                            <input type="file" class="hidden">
                                        </div>
                                        <button type="button"
                                            onclick="alert('جارٍ الاتصال بالماسح الضوئي (Scanner)... \nتم العثور على جهاز: HP LaserJet Pro MFP')"
                                            class="border-2 border-dashed border-brand-300 rounded-lg p-8 flex flex-col items-center justify-center bg-brand-50 hover:bg-brand-100 transition cursor-pointer group">
                                            <i
                                                class="fa-solid fa-print text-3xl text-brand-400 group-hover:text-brand-600 mb-2"></i>
                                            <span class="text-sm text-brand-600 font-bold">مسح ضوئي (Scanner)</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div
                                    class="col-span-12 border-t border-gray-100 pt-6 flex items-center justify-start gap-4">
                                    <button type="submit"
                                        class="bg-brand-600 hover:bg-brand-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition flex items-center gap-2">
                                        <i class="fa-solid fa-paper-plane"></i> إرسال الكتاب
                                    </button>
                                    <button type="button"
                                        class="text-gray-500 hover:text-gray-700 px-6 py-3 font-medium transition">حفظ
                                        كمسودة</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- TAB: SENT -->
                    <div id="tab-sent" class="hidden fade-in">
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="fa-solid fa-paper-plane text-6xl mb-4 text-gray-200"></i>
                            <h3 class="text-lg font-bold">البريد المرسل</h3>
                            <p class="text-sm">لا توجد رسائل مرسلة بعد</p>
                        </div>
                    </div>
                    <!-- TAB: ARCHIVE -->
                    <div id="tab-archive" class="hidden fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700">سجل الأرشيف العام</h3>
                                <button onclick="window.print()"
                                    class="text-gray-500 hover:text-brand-600 transition"><i
                                        class="fa-solid fa-print"></i> طباعة السجل</button>
                            </div>
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-50 border-b border-gray-100 text-gray-500">
                                    <tr>
                                        <th class="px-6 py-4 font-medium">ت</th>
                                        <th class="px-6 py-4 font-medium">رقم الكتاب</th>
                                        <th class="px-6 py-4 font-medium">تاريخ الكتاب</th>
                                        <th class="px-6 py-4 font-medium">الموضوع</th>
                                        <th class="px-6 py-4 font-medium">الجهة المرسلة</th>
                                        <th class="px-6 py-4 font-medium">تاريخ الاستلام</th>
                                        <th class="px-6 py-4 font-medium text-center">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 text-gray-700">
                                    <!-- Example Row -->
                                    <tr class="hover:bg-brand-50 transition">
                                        <td class="px-6 py-4">1</td>
                                        <td class="px-6 py-4 font-mono">HR-2024-892</td>
                                        <td class="px-6 py-4">2024/12/20</td>
                                        <td class="px-6 py-4">أمر إداري / تشكيل لجنة</td>
                                        <td class="px-6 py-4">مكتب الوزير</td>
                                        <td class="px-6 py-4">2024/12/28</td>
                                        <td class="px-6 py-4 flex justify-center gap-2">
                                            <button onclick="viewBookCopy('sample.pdf')" title="عرض نسخة"
                                                class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center transition">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                            <button onclick="printBook('HR-2024-892')" title="طباعة الكتاب"
                                                class="w-8 h-8 rounded-full bg-gray-50 text-gray-600 hover:bg-gray-100 flex items-center justify-center transition">
                                                <i class="fa-solid fa-print"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB: USERS (ADMIN) -->
                    <div id="tab-users" class="hidden fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 max-w-4xl mx-auto">
                            <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                                <i class="fa-solid fa-user-plus text-brand-600"></i>
                                إضافة مستخدم جديد
                            </h3>
                            <form onsubmit="handleAddUser(event)" class="space-y-4 mb-8">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">القسم /
                                            المديرية</label>
                                        <input type="text" name="department" required
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">اسم الموظف</label>
                                        <input type="text" name="employeeName" required
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none"
                                            placeholder="مثال: محمد احمد">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">العنوان
                                            الوظيفي</label>
                                        <input type="text" name="jobTitle" required
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none"
                                            placeholder="مثال: مدير قسم">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم</label>
                                        <input type="text" name="username" required
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                                        <input type="password" name="password" required
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                                        <input type="tel" name="phone"
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none"
                                            placeholder="077...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">الصلاحية</label>
                                        <select name="role"
                                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                            <option value="user">مستخدم عادي</option>
                                            <option value="admin">مدير نظام</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit"
                                    class="bg-brand-600 text-white px-6 py-2 rounded-lg hover:bg-brand-700 transition">إضافة
                                    المستخدم</button>
                            </form>

                            <hr class="my-6">

                            <h4 class="font-bold mb-4">المستخدمون الحاليون</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-right border-collapse">
                                    <thead class="bg-gray-50 text-gray-500">
                                        <tr>
                                            <th class="px-4 py-2 border border-gray-200">القسم / المديرية</th>
                                            <th class="px-4 py-2 border border-gray-200">اسم الموظف</th>
                                            <th class="px-4 py-2 border border-gray-200">العنوان الوظيفي</th>
                                            <th class="px-4 py-2 border border-gray-200">اسم الدخول</th>
                                            <th class="px-4 py-2 border border-gray-200">كلمة المرور</th>
                                            <th class="px-4 py-2 border border-gray-200">رقم الهاتف</th>
                                            <th class="px-4 py-2 border border-gray-200">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- Users rows will act here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Network Configuration
        const API_URL = '/api';

        const state = {
            currentUser: null,
            currentTab: 'inbox',
            selectedRecipients: [],
            // Local cache for display
            users: [],
            messages: []
        };

        // Views
        const viewLogin = document.getElementById('view-login');
        const viewDashboard = document.getElementById('view-dashboard');

        // Tabs
        const tabs = {
            inbox: document.getElementById('tab-inbox'),
            compose: document.getElementById('tab-compose'),
            sent: document.getElementById('tab-sent'),
            archive: document.getElementById('tab-archive'),
            users: document.getElementById('tab-users')
        };
        const navButtons = {
            inbox: document.getElementById('nav-inbox'),
            compose: document.getElementById('nav-compose'),
            sent: document.getElementById('nav-sent'),
            archive: document.getElementById('nav-archive'),
            users: document.getElementById('nav-users')
        };

        // Functions
        async function handleLogin(e) {
            e.preventDefault();
            const userIn = document.getElementById('username').value;
            // In real app, get password from input
            const passIn = e.target.querySelector('input[type="password"]').value;

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> جاري التحقق...';

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: userIn, password: passIn })
                });
                const data = await response.json();

                if (data.success) {
                    state.currentUser = data.user;
                    viewLogin.classList.add('hidden');
                    viewDashboard.classList.remove('hidden');

                    // Initial Data Load
                    await loadData();
                    // Start Polling
                    setInterval(loadData, 5000);

                    // Setup UI based on role
                    if (state.currentUser.role === 'admin') {
                        document.getElementById('nav-users').classList.remove('hidden');
                    } else {
                        document.getElementById('nav-users').classList.add('hidden');
                    }

                    // Show inbox by default
                    switchTab('inbox');

                    // Lock sender field logic
                    const senderField = document.getElementById('sender-entity');
                    if (senderField) {
                        senderField.value = state.currentUser.dept;
                        senderField.setAttribute('readonly', 'true');
                        senderField.classList.add('bg-gray-100', 'cursor-not-allowed');
                        senderField.setAttribute('title', 'تم قفل هذا الحقل تلقائياً حسب قسمك');
                    }

                } else {
                    alert('خطأ: اسم المستخدم أو كلمة المرور غير صحيحة');
                    btn.innerText = originalText;
                }
            } catch (error) {
                alert('فشل الاتصال بالخادم. تأكد من تشغيل server.js');
                console.error(error);
                btn.innerText = originalText;
            }
        }

        async function loadData() {
            try {
                const [msgRes, userRes] = await Promise.all([
                    fetch(`${API_URL}/messages`),
                    fetch(`${API_URL}/users`)
                ]);
                state.messages = await msgRes.json();
                state.users = await userRes.json();

                // Refresh current view
                if (state.currentTab === 'inbox') renderInbox();
                if (state.currentTab === 'compose') renderSideInbox();
                if (state.currentTab === 'users') renderUsersList();
                if (state.currentTab === 'archive') renderArchive();

                // Update badge
                updateInboxBadge();
            } catch (err) {
                console.error('Data sync failed:', err);
            }
        }

        function updateInboxBadge() {
            const myMessages = state.messages.filter(m => m.to === state.currentUser.dept && m.status === 'جديد');
            const badge = document.querySelector('#nav-inbox span.bg-red-500');
            if (badge) {
                if (myMessages.length > 0) {
                    badge.innerText = myMessages.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function updateUserInfoUI() {
            // Update Sidebar User Info
            // Checking if elements exist first or just updating assuming they are static mostly
            // You might want to add IDs to the sidebar user name/dept elements to target them better.
            // For now, let's keep it simple or assume we will add IDs.
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                window.location.reload();
            }
        }

        function switchTab(tabName) {
            state.currentTab = tabName;

            // Hide all tabs
            Object.values(tabs).forEach(el => el.classList.add('hidden'));
            // Remove active style from nav
            Object.values(navButtons).forEach(el => el.classList.remove('sidebar-item-active'));

            // Show new tab
            if (tabs[tabName]) tabs[tabName].classList.remove('hidden');
            if (navButtons[tabName]) navButtons[tabName].classList.add('sidebar-item-active');

            // Update Header Title
            const titles = {
                'inbox': 'البريد الوارد',
                'compose': 'إنشاء كتاب رسمي جديد',
                'sent': 'البريد المرسل',
                'archive': 'أرشيف المراسلات'
            };
            document.getElementById('page-title').innerText = titles[tabName] || 'الرئيسية';

            if (tabName === 'users') {
                renderUsersList();
            } else if (tabName === 'inbox') {
                renderInbox();
            } else if (tabName === 'archive') {
                renderArchive();
            } else if (tabName === 'compose') {
                renderSideInbox();
            }
        }

        function renderSideInbox() {
            const container = document.getElementById('side-inbox-body');
            if (!container) return;

            // Filter messages for current user
            const messages = state.messages.filter(m => {
                if (state.currentUser.role === 'admin') return true;
                return m.to === state.currentUser.dept;
            });

            if (messages.length === 0) {
                container.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-400 text-xs">لا يوجد بريد وارد حديث</td></tr>`;
                return;
            }

            container.innerHTML = messages.map(m => `
                <tr class="hover:bg-brand-50 transition border-b border-gray-50">
                    <td class="px-3 py-2 font-mono text-xs text-brand-700 font-bold">${m.number}</td>
                    <td class="px-3 py-2 text-xs text-gray-500">${m.date}</td>
                    <td class="px-3 py-2 text-center">
                         <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px]">${m.status}</span>
                    </td>
                </tr>
            `).join('');
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newUser = Object.fromEntries(formData.entries());

            try {
                const res = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newUser)
                });

                if (res.ok) {
                    alert('تم إضافة المستخدم بنجاح');
                    e.target.reset();
                    loadData(); // Refresh list
                } else {
                    alert('خطأ في إضافة المستخدم');
                }
            } catch (err) {
                alert('خطأ في الاتصال');
            }
        }

        function renderUsersList() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;

            tbody.innerHTML = state.users.map(u => `
                <tr class="hover:bg-gray-50 border-b border-gray-100 transition">
                    <td class="px-4 py-3">${u.dept}</td>
                    <td class="px-4 py-3 font-bold text-gray-800">${u.employeeName || '-'}</td>
                    <td class="px-4 py-3 text-gray-600">${u.jobTitle || '-'}</td>
                    <td class="px-4 py-3">${u.username}</td>
                    <td class="px-4 py-3 font-mono text-xs">****</td>
                    <td class="px-4 py-3 text-gray-500">${u.phone || '-'}</td>
                    <td class="px-4 py-3 flex gap-2">
                        <button onclick="resetPassword('${u.username}')" class="text-red-500 hover:text-red-700 p-1" title="إعادة تعيين كلمة المرور">
                            <i class="fa-solid fa-key"></i>
                        </button>
                         <button class="text-blue-500 hover:text-blue-700 p-1">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </td>
                </tr>
             `).join('');
        }

        function resetPassword(username) {
            if (confirm(`هل أنت متأكد من إعادة تعيين كلمة المرور للمستخدم ${username}؟`)) {
                alert('تم إعادة تعيين كلمة المرور إلى: 123456');
                // In real app: fetch(API_URL + '/reset-password', ...)
            }
        }

        function renderInbox() {
            const tbody = document.querySelector('#tab-inbox tbody');
            if (!tbody) return;

            // Filter messages for current user
            const myMessages = state.messages.filter(m => m.type === 'inbox' && m.to === state.currentUser.dept);

            tbody.innerHTML = myMessages.map(m => `
                <tr class="hover:bg-brand-50 transition cursor-pointer group">
                    <td class="px-6 py-4 font-bold text-gray-900 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        ${m.from}
                    </td>
                    <td class="px-6 py-4">${m.subject}</td>
                    <td class="px-6 py-4 font-mono text-xs">${m.number}</td>
                    <td class="px-6 py-4 text-gray-500">${m.date}</td>
                    <td class="px-6 py-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">${m.status}</span></td>
                    <td class="px-6 py-4"><button class="text-brand-600 hover:bg-brand-50 px-3 py-1 rounded-lg">فتح</button></td>
                </tr>
            `).join('');

            if (myMessages.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-400">لا يوجد بريد وارد</td></tr>`;
            }
        }

        function renderArchive() {
            // Similarly check state.messages for archive logic if needed,
            // but for now we just show all if admin or user specific
            // Simplification: Archive shows everything for demo

            const tbody = document.querySelector('#tab-archive tbody');
            if (!tbody) return;
            // Demo: show all messages in archive
            tbody.innerHTML = state.messages.map((m, i) => `
                <tr class="hover:bg-brand-50 transition">
                     <td class="px-6 py-4">${i + 1}</td>
                     <td class="px-6 py-4 font-mono">${m.number}</td>
                     <td class="px-6 py-4">${m.date}</td>
                     <td class="px-6 py-4">${m.subject}</td>
                     <td class="px-6 py-4">${m.from}</td>
                     <td class="px-6 py-4">${m.date}</td> <!-- Received Date Sim -->
                     <td class="px-6 py-4 flex justify-center gap-2">
                        <button class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center transition"><i class="fa-solid fa-eye"></i></button>
                    </td>
                </tr>
             `).join('');

            if (state.messages.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400">الأرشيف فارغ</td></tr>`;
            }
        }

        function addRecipient() {
            const select = document.getElementById('recipient-select');
            const value = select.value;
            if (value && !state.selectedRecipients.includes(value)) {
                state.selectedRecipients.push(value);
                renderRecipients();
            }
        }

        function removeRecipient(value) {
            state.selectedRecipients = state.selectedRecipients.filter(r => r !== value);
            renderRecipients();
        }

        function renderRecipients() {
            const container = document.getElementById('recipients-list');
            container.innerHTML = state.selectedRecipients.map(r => `
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-700 border border-brand-100 animate-fadeIn">
                    ${r}
                    <button type="button" onclick="removeRecipient('${r}')" class="hover:text-red-500 focus:outline-none transition-colors w-4 h-4 flex items-center justify-center rounded-full hover:bg-red-50">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </span>
            `).join('');
        }

        async function handleSend(e) {
            e.preventDefault();

            const recipients = state.selectedRecipients.length > 0 ? state.selectedRecipients : [document.getElementById('recipient-select').value];
            if (recipients.length === 0 || !recipients[0]) {
                alert('يرجى اختيار جهة مستلمة واحدة على الأقل');
                return;
            }

            const subject = e.target.querySelector('input[placeholder*="عنوان"]').value;
            const number = e.target.querySelector('input[placeholder*="رقم"]').value || 'GEN-' + Date.now();

            // Send to ALL recipients
            try {
                for (const recipient of recipients) {
                    const msg = {
                        type: 'inbox',
                        from: state.currentUser.dept,
                        to: recipient,
                        subject: subject,
                        number: number,
                        date: new Date().toISOString().split('T')[0],
                        status: 'جديد'
                    };

                    await fetch(`${API_URL}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(msg)
                    });
                }

                alert(`تم إرسال الكتاب بنجاح إلى: \n${recipients.join('\n')}`);
                e.target.reset();
                state.selectedRecipients = [];
                renderRecipients();
                loadData();
            } catch (err) {
                alert('خطأ في الإرسال');
                console.error(err);
            }
        }
    </script>
</body>

</html>